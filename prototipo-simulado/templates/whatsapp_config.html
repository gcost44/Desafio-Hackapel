<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√£o WhatsApp - Evolution API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            color: #1a1a1a;
            line-height: 1.6;
        }
        
        .navbar {
            background: #1a1a1a;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar h1 {
            font-size: 1.5rem;
        }
        
        .navbar a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid white;
            border-radius: 4px;
            transition: 0.3s;
        }
        
        .navbar a:hover {
            background: white;
            color: #1a1a1a;
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .status-card {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .status-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .status-dot.conectado {
            background: #25D366;
            box-shadow: 0 0 10px #25D366;
        }
        
        .status-dot.desconectado {
            background: #e74c3c;
        }
        
        .status-dot.simulacao {
            background: #f39c12;
        }
        
        .qrcode-container {
            text-align: center;
            padding: 2rem;
            background: #f8f8f8;
            border-radius: 4px;
            margin: 1.5rem 0;
        }
        
        .qrcode-container img {
            max-width: 300px;
            border: 5px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.3s;
            margin-right: 0.5rem;
        }
        
        .btn-primary {
            background: #25D366;
            color: white;
        }
        
        .btn-primary:hover {
            background: #128C7E;
        }
        
        .btn-secondary {
            background: #e5e5e5;
            color: #1a1a1a;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .info-box {
            background: #E3F2FD;
            border-left: 4px solid #2196F3;
            padding: 1rem;
            margin: 1.5rem 0;
        }
        
        .warning-box {
            background: #FFF3E0;
            border-left: 4px solid #FF9800;
            padding: 1rem;
            margin: 1.5rem 0;
        }
        
        .success-box {
            background: #E8F5E9;
            border-left: 4px solid #4CAF50;
            padding: 1rem;
            margin: 1.5rem 0;
        }
        
        .config-section {
            margin-bottom: 2rem;
        }
        
        .config-section h2 {
            margin-bottom: 1rem;
            color: #1a1a1a;
        }
        
        .config-section code {
            background: #f5f5f5;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loading.active {
            display: block;
        }
        
        pre {
            background: #1a1a1a;
            color: #00ff00;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>üü¢ Configura√ß√£o WhatsApp Evolution API</h1>
        <a href="/">‚Üê Voltar ao Sistema</a>
    </nav>
    
    <div class="container">
        <!-- Status da Conex√£o -->
        <div class="status-card">
            <h2>Status da Conex√£o</h2>
            <div class="status-indicator" id="statusIndicator">
                <div class="status-dot simulacao"></div>
                <div>
                    <strong id="statusText">Verificando...</strong><br>
                    <small id="statusDetails">Aguarde...</small>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="verificarStatus()">üîÑ Atualizar Status</button>
            <button class="btn btn-primary" onclick="mostrarQRCode()">üì± Obter QR Code</button>
            <button class="btn btn-secondary" onclick="criarInstancia()">‚ûï Criar Inst√¢ncia</button>
            <button class="btn btn-secondary" onclick="configurarWebhook()" style="background: #28a745;">üîó Ativar Respostas Autom√°ticas</button>
        </div>
        
        <!-- QR Code -->
        <div class="status-card" id="qrcodeSection" style="display: none;">
            <h2>QR Code para Conectar</h2>
            <div class="info-box">
                <strong>üì± Como conectar:</strong>
                <ol style="margin-left: 1.5rem; margin-top: 0.5rem;">
                    <li>Abra o WhatsApp no seu celular</li>
                    <li>Toque em Menu (‚ãÆ) ou Configura√ß√µes</li>
                    <li>Toque em "Aparelhos conectados"</li>
                    <li>Toque em "Conectar um aparelho"</li>
                    <li>Aponte a c√¢mera para este QR Code</li>
                </ol>
            </div>
            
            <div class="qrcode-container" id="qrcodeContainer">
                <div class="loading active">Gerando QR Code...</div>
            </div>
        </div>
        
        <!-- Configura√ß√£o -->
        <div class="status-card config-section">
            <h2>üìã Configura√ß√£o Evolution API</h2>
            
            <div id="configInfo"></div>
            
            <div class="warning-box">
                <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Para usar WhatsApp REAL, voc√™ precisa configurar as vari√°veis de ambiente no Railway.
            </div>
            
            <h3>Vari√°veis de Ambiente Necess√°rias:</h3>
            <pre>
EVOLUTION_API_URL=https://sua-api.evolutionapi.com
EVOLUTION_API_KEY=sua-chave-api-aqui
EVOLUTION_INSTANCE=sus-agendamentos
            </pre>
            
            <div class="info-box">
                <strong>üöÄ Deploy Evolution API (Docker):</strong>
                <pre style="margin-top: 0.5rem;">
docker run -d \
  --name evolution-api \
  -p 8080:8080 \
  -e AUTHENTICATION_API_KEY=SUA_CHAVE_SECRETA \
  atendai/evolution-api:latest
                </pre>
            </div>
        </div>
        
        <!-- Guia Completo -->
        <div class="status-card config-section">
            <h2>üìñ Guia Completo de Instala√ß√£o</h2>
            
            <h3>Op√ß√£o 1: Docker (Recomendado)</h3>
            <ol style="margin-left: 1.5rem;">
                <li>Instale Docker: <code>https://docker.com</code></li>
                <li>Execute o comando acima</li>
                <li>API estar√° em: <code>http://localhost:8080</code></li>
                <li>Configure as vari√°veis no Railway</li>
            </ol>
            
            <h3 style="margin-top: 1.5rem;">Op√ß√£o 2: Railway Pr√≥prio</h3>
            <ol style="margin-left: 1.5rem;">
                <li>Fork do reposit√≥rio: <code>https://github.com/EvolutionAPI/evolution-api</code></li>
                <li>Deploy no Railway</li>
                <li>Copie a URL gerada</li>
                <li>Configure as vari√°veis de ambiente</li>
            </ol>
            
            <div class="success-box" style="margin-top: 1.5rem;">
                <strong>‚úÖ Ap√≥s configurar:</strong><br>
                O sistema enviar√° mensagens REAIS via WhatsApp automaticamente!<br>
                ‚Ä¢ Agendamentos confirmados<br>
                ‚Ä¢ √Åudio para idosos<br>
                ‚Ä¢ Lembretes autom√°ticos<br>
                ‚Ä¢ Confirma√ß√µes/Cancelamentos
            </div>
        </div>
    </div>
    
    <script>
        // Verificar status ao carregar
        window.onload = () => {
            verificarStatus();
            carregarConfig();
        };
        
        async function verificarStatus() {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const statusDetails = document.getElementById('statusDetails');
            
            try {
                console.log('üîç Verificando status...');
                const response = await fetch('/api/whatsapp/status');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä Dados recebidos:', data);
                
                if (data.simulacao) {
                    indicator.querySelector('.status-dot').className = 'status-dot simulacao';
                    statusText.textContent = 'Modo Simula√ß√£o';
                    statusDetails.textContent = 'Configure Evolution API para envio real';
                } else if (data.conectado) {
                    indicator.querySelector('.status-dot').className = 'status-dot conectado';
                    statusText.textContent = 'üü¢ WhatsApp Conectado!';
                    statusDetails.textContent = 'Pronto para enviar mensagens reais!';
                } else {
                    indicator.querySelector('.status-dot').className = 'status-dot desconectado';
                    statusText.textContent = 'WhatsApp Desconectado';
                    statusDetails.textContent = data.erro || 'Clique em "Obter QR Code" para conectar';
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar status:', error);
                indicator.querySelector('.status-dot').className = 'status-dot desconectado';
                statusText.textContent = 'Erro ao Verificar';
                statusDetails.textContent = `Erro: ${error.message}`;
            }
        }
        
        async function criarInstancia() {
            const section = document.getElementById('qrcodeSection');
            section.style.display = 'block';
            
            const container = document.getElementById('qrcodeContainer');
            container.innerHTML = '<div class="loading active">Criando inst√¢ncia WhatsApp...</div>';
            
            try {
                const response = await fetch('/api/whatsapp/criar-instancia', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.sucesso && data.qrcode) {
                    container.innerHTML = `
                        <div class="success-box">
                            <strong>‚úÖ Inst√¢ncia criada com sucesso!</strong><br>
                            Escaneie o QR Code abaixo
                        </div>
                        <img src="${data.qrcode}" alt="QR Code WhatsApp">
                    `;
                    setTimeout(verificarStatus, 2000);
                } else {
                    container.innerHTML = `
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Erro ao criar inst√¢ncia</strong><br>
                            ${data.erro || 'Tente novamente'}
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="warning-box">
                        <strong>‚ùå Erro:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        async function mostrarQRCode() {
            const section = document.getElementById('qrcodeSection');
            section.style.display = 'block';
            
            const container = document.getElementById('qrcodeContainer');
            container.innerHTML = '<div class="loading active">Gerando QR Code (cria inst√¢ncia automaticamente se necess√°rio)...</div>';
            
            try {
                const response = await fetch('/api/whatsapp/qrcode');
                const data = await response.json();
                
                if (data.sucesso && data.qrcode) {
                    let mensagem = '';
                    if (data.mensagem) {
                        mensagem = `
                            <div class="info-box">
                                <strong>‚ÑπÔ∏è ${data.mensagem}</strong>
                            </div>
                        `;
                    }
                    container.innerHTML = `${mensagem}<img src="${data.qrcode}" alt="QR Code WhatsApp">`;
                    setTimeout(verificarStatus, 2000);
                } else {
                    container.innerHTML = `
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Erro ao gerar QR Code</strong><br>
                            ${data.erro || 'Configure Evolution API primeiro'}<br><br>
                            <button class="btn btn-primary" onclick="criarInstancia()">‚ûï Criar Inst√¢ncia Manualmente</button>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="warning-box">
                        <strong>‚ùå Erro:</strong> ${error.message}
                    </div>
                `;
            }
        }
        
        async function configurarWebhook() {
            if (!confirm('üîó Ativar respostas autom√°ticas?\n\nQuando pacientes responderem:\n‚Ä¢ 1 = Confirmar consulta\n‚Ä¢ 2 = Cancelar consulta\n\nO sistema processar√° automaticamente.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/whatsapp/configurar-webhook', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                
                const data = await response.json();
                
                if (data.sucesso) {
                    alert('‚úÖ Respostas autom√°ticas ativadas!\n\nAgora quando pacientes responderem 1 ou 2, o sistema processar√° automaticamente.');
                } else {
                    alert('‚ùå Erro: ' + (data.erro || 'Erro desconhecido'));
                }
            } catch (error) {
                alert('‚ùå Erro ao configurar: ' + error.message);
            }
        }
        
        async function carregarConfig() {
            try {
                const response = await fetch('/api/whatsapp/config');
                const data = await response.json();
                
                const configInfo = document.getElementById('configInfo');
                configInfo.innerHTML = `
                    <p><strong>URL Base:</strong> <code>${data.base_url}</code></p>
                    <p><strong>Inst√¢ncia:</strong> <code>${data.instance_name}</code></p>
                    <p><strong>Modo:</strong> ${data.modo_simulacao ? '‚ö†Ô∏è Simula√ß√£o' : '‚úÖ API Configurada'}</p>
                `;
            } catch (error) {
                console.error('Erro ao carregar config:', error);
            }
        }
    </script>
</body>
</html>
